<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>予約フォーム（LIFF）雛形</title>
  <style>
    /* シンプルなスタイル：スマホ向けに最適化 */
    :root{font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif}
    body{margin:0;padding:16px;background:#f7fafc;color:#0f172a}
    .container{max-width:720px;margin:0 auto}
    h1{font-size:1.25rem;margin-bottom:8px}
    label{display:block;margin-top:12px;font-weight:600}
    input[type="date"], input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e2e8f0;background:#fff}
    #slots{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .slot{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;min-width:84px;text-align:center}
    .slot.disabled{opacity:0.45;cursor:not-allowed}
    .slot.selected{background:#06b6d4;color:#fff;border-color:transparent}
    button.primary{display:block;width:100%;padding:12px;border-radius:10px;border:0;background:#0ea5a3;color:#fff;font-weight:700;margin-top:14px}
    .msg{margin-top:12px}
    .small{font-size:0.85rem;color:#475569}
  </style>
</head>
<body>
  <div class="container">
    <h1>予約フォーム</h1>

    <label for="name">名前</label>
    <input id="name" type="text" placeholder="山田太郎" />

    <label for="date">日付</label>
    <input id="date" type="date" />

   <label>時刻:
  <select id="time" required>
    <option value="">選択してください</option>
    <option value="09:00">09:00</option>
    <option value="09:30">09:30</option>
    <option value="10:00">10:00</option>
    <option value="10:30">10:30</option>
    <option value="11:00">11:00</option>
    <option value="11:30">11:30</option>
    <option value="12:00">12:00</option>
    <option value="12:30">12:30</option>
    <option value="13:00">13:00</option>
    <option value="13:30">13:30</option>
    <option value="14:00">14:00</option>
    <option value="14:30">14:30</option>
    <option value="15:00">15:00</option>
    <option value="15:30">15:30</option>
    <option value="16:00">16:00</option>
    <option value="16:30">16:30</option>
    <option value="17:00">17:00</option>
    <option value="17:30">17:30</option>
    <option value="18:00">18:00</option>
  </select>
</label>

    <div id="slots"></div>

    <button id="reserveBtn" class="primary" disabled>予約する</button>

    <div class="msg" id="message"></div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
    /*
      使い方 (雛形):
      1) 下の LIFF_ID と GAS_BASE_URL を実際の値に置き換えてください。
      2) LIFF のスコープに "profile" を含めると名前やuserIdを取得できます。
      3) GAS は doGet(date) で当日の予約配列を返し、doPost で予約登録する想定です。
    */

    const LIFF_ID = "2008012264-GAaEPJdZ"; // ← ここを置き換える
    const GAS_BASE_URL = "https://script.google.com/a/macros/ict.shimanet.ed.jp/s/AKfycbzu8WI-QQoja6mi1tKqEw3CtT6xPowzyE6U-Hw0TbpUtrUK8hvtvA_UaYv7e4u949jGyw/exec"; // 例: https://script.google.com/macros/s/XXXX/exec

    // 営業時間（必要に応じて変更）
    const OPEN_TIME = "09:00";
    const CLOSE_TIME = "18:00";

    // state
    let selectedTime = null;
    let selectedDate = null;

    // utils
    function toMinutes(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60+m; }
    function fromMinutes(min){ const h=Math.floor(min/60); const m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
    function generateSlots(start=OPEN_TIME, end=CLOSE_TIME){ const out=[]; for(let t=toMinutes(start); t<toMinutes(end); t+=30) out.push(fromMinutes(t)); return out; }

    // DOM
    const nameInput = document.getElementById('name');
    const dateInput = document.getElementById('date');
    const slotsEl = document.getElementById('slots');
    const reserveBtn = document.getElementById('reserveBtn');
    const messageEl = document.getElementById('message');

    // 初期化: 日付を今日にする
    function initDate(){ const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); dateInput.value=`${yyyy}-${mm}-${dd}`; }

    // LIFF init
    async function initLiff(){
      try{
        await liff.init({ liffId: LIFF_ID });
        // プロフィールを取って名前をセット（許可がある場合のみ）
        try{
          const profile = await liff.getProfile();
          if(profile && profile.displayName) nameInput.value = profile.displayName;
        }catch(e){}
      }catch(e){ console.warn('LIFF init failed', e); }
    }

    // 既存予約を取得して枠を描画
    async function renderSlots(){
      const date = dateInput.value;
      selectedDate = date;
      selectedTime = null;
      reserveBtn.disabled = true;
      messageEl.textContent = '';

      // 空の時に生成
      const allSlots = generateSlots();

      // fetch existing bookings
      let bookedTimes = new Set();
      try{
        const res = await fetch(`${GAS_BASE_URL}?date=${encodeURIComponent(date)}`);
        if(res.ok){
          const data = await res.json();
          // data は配列 { date, time, name, ... }
          data.forEach(r => { if(r.time) bookedTimes.add(r.time); else if(r['予約時刻']) bookedTimes.add(r['予約時刻']); });
        }else{
          console.warn('GET failed', res.status);
        }
      }catch(e){ console.warn('fetch error', e); }

      // 表示
      slotsEl.innerHTML = '';
      allSlots.forEach(t => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'slot';
        btn.textContent = t;
        if(bookedTimes.has(t)){
          btn.classList.add('disabled');
          btn.disabled = true;
        } else {
          btn.addEventListener('click', ()=>{
            document.querySelectorAll('.slot').forEach(el=>el.classList.remove('selected'));
            btn.classList.add('selected');
            selectedTime = t;
            reserveBtn.disabled = false;
          });
        }
        slotsEl.appendChild(btn);
      });
    }

    // 予約実行
    async function doReserve(){
      if(!selectedDate || !selectedTime){ alert('日付と時間を選んでください'); return; }
      const name = nameInput.value.trim();
      if(!name){ alert('名前を入力してください'); return; }

      reserveBtn.disabled = true;
      messageEl.textContent = '送信中…';

      // LIFFでuserIdが取れるなら送る
      let lineId = '';
      try{ const profile = await liff.getProfile(); lineId = profile.userId || ''; }catch(e){}

      try{
        const res = await fetch(GAS_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name, date: selectedDate, time: selectedTime, lineId: lineId })
        });
        const j = await res.json();
        if(j.success){
          messageEl.textContent = '✅ ' + j.message;
          // 再読み込みして最新状態に
          await renderSlots();
        } else {
          messageEl.textContent = '⚠️ ' + (j.message || '予約に失敗しました');
        }
      }catch(e){
        messageEl.textContent = 'エラーが発生しました';
        console.error(e);
      } finally {
        reserveBtn.disabled = false;
      }
    }

    // イベント
    dateInput.addEventListener('change', renderSlots);
    reserveBtn.addEventListener('click', doReserve);

    // 起動
    (async ()=>{
      initDate();
      await initLiff();
      await renderSlots();
    })();
  </script>
</body>
</html>
