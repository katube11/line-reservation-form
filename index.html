<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>予約フォーム (LINE対応)</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root {
    --primary-color:#007B8C;
    --secondary-color:#00B1AD;
    --accent-color:#FF7043;
    --background-color:#f0f2f5;
    --card-background:#fff;
    --text-color:#333;
    --light-text-color:#666;
    --border-color:#e0e0e0;
    --shadow-light:0 4px 15px rgba(0,0,0,0.08);
    --shadow-medium:0 8px 25px rgba(0,0,0,0.12);
    --success-color:#28a745;
    --error-color:#dc3545;
  }
  *{box-sizing:border-box;}
  body{font-family:'Noto Sans JP', 'Inter', sans-serif; background:var(--background-color); margin:0; padding:20px; display:flex; justify-content:center; align-items:center; min-height:100vh; color:var(--text-color);}
  .container{background:var(--card-background); border-radius:20px; box-shadow:var(--shadow-medium); padding:40px; max-width:600px; width:100%; position:relative; overflow:hidden;}
  h2{text-align:center; font-size:32px; color:var(--primary-color);}
  label{display:block; margin-top:20px; font-weight:600; font-size:18px; color:var(--light-text-color); margin-bottom:5px;}
  input[type="text"]{width:100%; padding:16px 20px; border-radius:12px; border:1px solid var(--border-color); font-size:18px;}
  #dates, #slots{display:grid; gap:12px; margin-top:10px;}
  .date-btn,.slot{padding:16px; border-radius:14px; border:1px solid var(--border-color); text-align:center; cursor:pointer; transition:all 0.2s;}
  .date-btn.selected,.slot.selected{background:var(--primary-color); color:#fff; border-color:var(--primary-color);}
  .slot.booked{background:#e9ecef;color:#999; cursor:not-allowed;}
  .primary{display:block;width:100%;padding:16px; border:none; border-radius:14px; background:var(--accent-color); color:#fff; font-size:20px; margin-top:30px; cursor:pointer;}
  .primary:disabled{opacity:0.6; cursor:not-allowed;}
  #message{margin-top:15px; font-size:16px; text-align:center;}
  /* モーダル */
  .modal-overlay{position:fixed; top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:1000; }
  .modal-overlay.active{display:flex;}
  .modal-content{background:#fff;padding:30px;border-radius:16px;text-align:center;}
  #modalCloseBtn{margin-top:20px;padding:10px 20px;border:none;border-radius:10px;background:var(--secondary-color);color:#fff;cursor:pointer;}
</style>
</head>
<body>
<div class="container">
  <h2>📅 予約フォーム</h2>
  <label for="name">お名前</label>
  <input id="name" type="text" placeholder="例: 山田太郎" autocomplete="name"/>
  <h3>日付を選択</h3>
  <div id="dates"></div>
  <h3>時間を選択</h3>
  <div id="slots"></div>
  <button id="reserveBtn" class="primary" disabled>予約を確定する</button>
  <div id="message"></div>
</div>

<div id="reservationModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-icon">✅</div>
    <h4>ご予約完了！</h4>
    <div id="modalDetails"></div>
    <button id="modalCloseBtn">閉じる</button>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // ここにGAS URL
const LIFF_ID = "2008012264-GAaEPJdZ"; // ここにLIFF ID

let liffUserId = "";

const datesEl=document.getElementById('dates');
const slotsEl=document.getElementById('slots');
const reserveBtn=document.getElementById('reserveBtn');
const messageEl=document.getElementById('message');
const nameEl=document.getElementById('name');
const modal=document.getElementById('reservationModal');
const modalDetails=document.getElementById('modalDetails');
const modalCloseBtn=document.getElementById('modalCloseBtn');

let selectedDate=null;
let selectedSlot=null;

modalCloseBtn.onclick=()=>{modal.classList.remove('active');};
modal.onclick=(e)=>{if(e.target===modal){modal.classList.remove('active');}};

// LIFF初期化
async function initLiff(){
  await liff.init({liffId: LIFF_ID});
  if(liff.isLoggedIn()){ const profile = await liff.getProfile(); liffUserId=profile.userId; nameEl.value=profile.displayName; updateButton();}
  else{ liff.login(); }
}

// 日付生成
function renderDates(){
  const today=new Date(); datesEl.innerHTML=''; const dayNames=["日","月","火","水","木","金","土"];
  for(let i=0;i<14;i++){
    const d=new Date(today); d.setDate(today.getDate()+i);
    const dateStr=d.toISOString().slice(0,10);
    const dayOfWeek=dayNames[d.getDay()];
    const btn=document.createElement('div'); btn.className='date-btn';
    btn.innerHTML=`<div>${dateStr.slice(5).replace('-','/')}</div><div class="day-of-week">(${dayOfWeek})</div>`;
    btn.onclick=()=>{
      selectedDate=dateStr; selectedSlot=null;
      fetchReservations(dateStr); renderDatesSelected(); updateButton(); messageEl.innerText=''; messageEl.className='';
    };
    datesEl.appendChild(btn);
  }
}
function renderDatesSelected(){ [...datesEl.children].forEach(btn=>{ const btnDateText=btn.firstElementChild.innerText; const selectedMonthDay=selectedDate?selectedDate.slice(5).replace('-','/'):null; btn.classList.toggle('selected',selectedMonthDay===btnDateText); }); }

// 時間生成
function generateTimes(){ const out=[]; let start=9*60,end=17*60,step=30; for(let cur=start;cur<=end;cur+=step){ const hh=String(Math.floor(cur/60)).padStart(2,'0'); const mm=String(cur%60).padStart(2,'0'); out.push(`${hh}:${mm}`);} return out; }

// 予約取得
function fetchReservations(dateStr){
  messageEl.innerText='予約状況を取得中...'; messageEl.className=''; slotsEl.innerHTML='';
  fetch(GAS_URL+'?date='+encodeURIComponent(dateStr)).then(res=>res.json())
  .then(data=>{ renderSlots(data,dateStr); messageEl.innerText=''; })
  .catch(err=>{ console.error(err); messageEl.innerText='予約状況の取得に失敗しました'; messageEl.className='error'; slotsEl.innerHTML='<p style="text-align:center;color:#666;">読み込めませんでした</p>'; });
}

// スロット描画
function renderSlots(reservations,dateStr){
  slotsEl.innerHTML=''; if(!dateStr){ slotsEl.innerHTML='<p style="text-align:center;color:#666;">日付を選択してください</p>'; return;}
  const now=new Date(); const todayStr=now.toISOString().slice(0,10);
  const bookedSet=new Set(reservations.map(r=>r.time));
  let hasAvailable=false;
  generateTimes().forEach(slot=>{
    const btn=document.createElement('div'); btn.className='slot'; btn.innerText=slot;
    let isPast=false;
    if(dateStr===todayStr){ const [hh,mm]=slot.split(':').map(Number); if(hh<now.getHours()||(hh===now.getHours()&&mm<=now.getMinutes())) isPast=true;}
    if(isPast||bookedSet.has(slot)){ btn.classList.add('booked');}else{ btn.onclick=()=>{selectedSlot=slot; renderSlots(reservations,dateStr); updateButton(); messageEl.innerText=''; messageEl.className='';}; hasAvailable=true;}
    if(slot===selectedSlot) btn.classList.add('selected');
    slotsEl.appendChild(btn);
  });
  if(!hasAvailable) slotsEl.innerHTML='<p style="text-align:center;color:#666;">予約可能な時間がありません</p>';
}

// ボタン有効化
function updateButton(){ reserveBtn.disabled=!(nameEl.value.trim()&&selectedDate&&selectedSlot);}
nameEl.addEventListener('input',updateButton);

// 予約送信
reserveBtn.onclick=()=>{
  const reservationName=nameEl.value.trim(); const reservationDate=selectedDate; const reservationTime=selectedSlot;
  if(!reservationName||!reservationDate||!reservationTime){ messageEl.innerText="名前、日付、時間を選択してください"; messageEl.className='error'; return;}
  messageEl.innerText='送信中...'; messageEl.className=''; reserveBtn.disabled=true;
  const form=new URLSearchParams();
  form.append('name',reservationName);
  form.append('date',reservationDate);
  form.append('time',reservationTime);
  form.append('lineUserId',liffUserId);
  fetch(GAS_URL,{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:form.toString()})
  .then(res=>res.json()).then(data=>{
    if(data.success){
      modalDetails.innerHTML=`<p>ご予約ありがとうございます、${reservationName}様</p><p>予約内容をご確認ください</p><strong>🗓 ${reservationDate.replace(/-/g,'/')}<br>🕒 ${reservationTime}</strong>`;
      modal.classList.add('active');
      selectedSlot=null; fetchReservations(selectedDate); updateButton();
      nameEl.value='';
    }else{ messageEl.innerText=data.message||"予約に失敗しました"; messageEl.className='error'; reserveBtn.disabled=false; }
  })
  .catch(err=>{ console.error(err); messageEl.innerText="通信エラー"; messageEl.className='error'; reserveBtn.disabled=false; });
};

// 初期化
initLiff(); renderDates(); renderSlots([],null); updateButton();
</script>
</body>
</html>
